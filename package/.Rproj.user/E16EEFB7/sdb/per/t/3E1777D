{
    "collab_server" : "",
    "contents" : "#\nboundsCuminc <- function(whichRisk, whichGroup, target, toPlot){\n    whichRisk <- as.character(whichRisk)\n    whichGroup <- as.character(whichGroup)\n    tmp <- as.data.frame(filter(toPlot, fac == whichRisk & col == whichGroup))\n    whichTime <- which(tmp$time <= target)\n    nr <- length(whichTime)\n    lower <- tmp$lowerBound[nr]\n    upper  <- tmp$upperBound[nr]\n    est <- tmp$est[nr]\n    c(lower, est, upper)\n\n}\n\nbarsDataCuminc <- function(risks, groups, target, toPlot){\n    barsData <- expand.grid(risks, groups)\n    colnames(barsData) <- c(\"fac\", \"col\")\n    barsData <- as.data.frame(barsData)\n\n\n    low <- numeric(nrow(barsData))\n    up <- numeric(nrow(barsData))\n    est <- numeric(nrow(barsData))\n    for(i in 1:nrow(barsData)){\n        tmpBounds <- as.numeric(boundsCuminc(barsData[i,1],barsData[i,2], target, toPlot))\n        low[i] <- tmpBounds[1]\n        est[i] <- tmpBounds[2]\n        up[i] <- tmpBounds[3]\n    }\n\n    barsData <- cbind(barsData, low, est, up)\n    barsData\n\n}\n\n\n\n#' @title Cumulative incidences curves\n#' @name plotCuminc\n#' @description The function plots cumulative incidences curves for each risk and group.\n#' @param ci a result of function fitCuminc.\n#' @param risk name of a column indicating type of event, can be numeric or factor/character.\n#' @param group name of a column indicating group variable, can be numeric or factor/character.\n#' @param target point in time, in which the confidence bounds should be plotted (default NULL, no confidence bounds plotted).\n#' @param ggtheme ggtheme to be used (default: theme_minimal()).\n#' @param titleCuminc a title of a plot (default: \"Cumulative incidence function\").\n#' @param xtitle a title of x axis (default: \"Time\").\n#' @param ytitleCuminc a title of y axis (default: \"Cumulative incidences\")\n#' @param legendtitle a title of a legend (default: \"Group\").\n#' @return a ggplot containing n graphs, where n is number of risks. Each graph represents cumulative incidence curves for given risk in each group.\n#' @export\n#' @examples fitC <- fitCuminc(time = \"time\", risk = \"event\", group = \"gender\", data = LUAD, cens = \"alive\")\n#' plotCuminc(ci = fitC, risk = \"event\", group = \"gender\", target = 1200)\n#' @importFrom dplyr filter\n#' @importFrom cmprsk cuminc\n\n\nplotCuminc <-function(ci,\n                      risk,\n                      group,\n                      target = NULL,\n                      ggtheme = theme_minimal(),\n                      titleCuminc = \"Cumulative incidence function\",\n                      xtitle = \"Time\",\n                      ytitleCuminc = \"Cumulative incidences\",\n                      legendtitle = \"Group\"){\n\n    #make long format\n    ci <- ci[-length(ci)]\n    aggNames <- names(ci)\n\n    toPlot <- data.frame()\n\n    for(i in aggNames){\n        tmp <- as.data.frame(ci[[i]])\n        tmp$name <- i\n        toPlot <- as.data.frame(rbind(toPlot, tmp))\n    }\n\n    riskGroup <- sapply(toPlot$name, function(x){\n        unlist(strsplit(x, split = \" \"))\n    })\n\n\n\n    riskGroup <- as.data.frame(riskGroup)\n    riskGroup <- t(riskGroup)\n    colnames(riskGroup) <- c(risk, group)\n    rownames(riskGroup) <- NULL\n\n    risks <- unique(riskGroup[,risk])\n    risks <- levels(factor(risks))\n\n    groups <- unique(riskGroup[,group])\n    groups <- levels(factor(groups))\n\n    toPlot <- cbind(toPlot, riskGroup)\n    toPlot <- toPlot[, !names(toPlot) %in% \"name\"]\n\n\n\n\n    #adding conf intervals\n    toPlot$lowerBound <- sapply(1:nrow(toPlot), function(x){\n        est <- toPlot[x, \"est\"]\n        var <- toPlot[x, \"var\"]\n        exp(log(est) - 1.96*sqrt(var)/est)\n    })\n\n    toPlot$upperBound <- sapply(1:nrow(toPlot), function(x){\n        est <- toPlot[x, \"est\"]\n        var <- toPlot[x, \"var\"]\n        exp(log(est) + 1.96*sqrt(var)/est)\n    })\n\n    colnames(toPlot)[which(colnames(toPlot) == risk)] <- \"fac\"\n    colnames(toPlot)[which(colnames(toPlot) == group)] <- \"col\"\n\n\n\n    if(!is.null(target) & is.numeric(target)){\n    barsData <- barsDataCuminc(risks, groups, target, toPlot)}\n\n    pd <- position_dodge(0.9)\n\n    timePoints <- extended_breaks()(toPlot$time)\n\n    #making a plot\n    plot1 <- ggplot(data = toPlot, aes(time, est, color = col)) +\n        geom_step(size=1) +\n        facet_grid(~fac)\n\n    #adding errorbars\n    if( !is.null(target) & is.numeric(target)){\n    plot1 <- plot1 +\n        geom_errorbar(data = barsData, aes(x = target, ymin = low, ymax = up),\n                      size = 1,\n                      alpha = 0.7,\n                      width = 0.7,\n                      position = pd)}\n\n    #making it beauty\n    plot1 <- plot1 +\n        theme_minimal() +\n        ggtitle(titleCuminc) +\n        theme(plot.title = element_text(size=13, face=\"bold\", hjust = 0.5), legend.position = \"top\") +\n        scale_y_continuous(ytitleCuminc, limits = c(0,1)) +\n        scale_x_continuous(xtitle, breaks = timePoints)+\n        theme(legend.title = element_text(size=10, face=\"bold\"))+\n        scale_color_discrete(name=legendtitle, labels = groups)\n\n    plot1\n}\n\n",
    "created" : 1499774710006.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "301426693",
    "id" : "3E1777D",
    "lastKnownWriteTime" : 1499776324,
    "last_content_update" : 1499776324373,
    "path" : "~/GitHub/cr17/package/R/plotCuminc.R",
    "project_path" : "R/plotCuminc.R",
    "properties" : {
    },
    "relative_order" : 3,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}