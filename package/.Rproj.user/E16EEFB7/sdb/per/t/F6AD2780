{
    "collab_server" : "",
    "contents" : "\n#data frame for plotting\ntoPlotDf <- function(fit){\n\n    risks <- names(fit)\n    risks <- levels(factor(risks))\n\n\n    #dealing with factor names of strata\n    badGroupNames <- levels(fit[[1]]$strata)\n    strataMapping <- 1:length(badGroupNames)\n\n    #ISSUE nazwy grup nie moga mieć w środku '='\n    groups <- sapply(as.character(badGroupNames), function(x) gsub(\"groups=\", replacement = \"\", x))\n    strataMapping <- cbind(strataMapping, groups)\n\n    colnames(strataMapping) <- c(\"strata\", \"group\")\n\n    toPlot <- data.frame()\n\n    for(i in risks){\n        tmp <- cbind(fit[[i]]$time,\n                     fit[[i]]$surv,\n                     fit[[i]]$strata,\n                     fit[[i]]$lower,\n                     fit[[i]]$upper,\n                     rep(i, times = length(fit[[i]]$time)))\n        tmp <- as.data.frame(tmp)\n        toPlot <- as.data.frame(rbind(toPlot, tmp))\n    }\n\n\n    colnames(toPlot) <- c(\"time\", \"prob\", \"strata\", \"lowerBound\", \"upperBound\", \"risk\")\n    toPlot <- merge(toPlot, strataMapping, by = \"strata\")\n\n    toPlot$time <- as.numeric(as.character(toPlot$time))\n    toPlot$prob <- as.numeric(as.character(toPlot$prob))\n    toPlot$lowerBound <- as.numeric(as.character(toPlot$lowerBound))\n    toPlot$upperBound <- as.numeric(as.character(toPlot$upperBound))\n    toPlot <- toPlot[, !names(toPlot) %in% \"strata\"]\n\n\n    #adding starting points\n    zeros <- expand.grid(risks, groups)\n    colnames(zeros) <- c(\"risk\", \"group\")\n    zeros$time <- 0\n    zeros$prob <- 1\n    zeros$lowerBound <- 1\n    zeros$upperBound <- 1\n\n    zeros <- zeros[, colnames(toPlot)]\n\n\n    toPlot <- rbind(toPlot, zeros)\n    toPlot\n\n}\n\n\n\n#########################\n\n#confidence intervals for simple analysis\n\nboundsSimpleSurv <- function(whichRisk, whichGroup, target, toPlot){\n    whichRisk <- as.character(whichRisk)\n    whichGroup <- as.character(whichGroup)\n    tmp <- as.data.frame(filter(toPlot, toPlot$risk == whichRisk & toPlot$group == whichGroup))\n    tmp <- tmp[order(tmp$time),]\n    whichTime <- which(tmp$time < target)\n    nr <- length(whichTime)\n    lower <- tmp$lowerBound[nr]\n    upper  <- tmp$upperBound[nr]\n    prob <- tmp$prob[nr]\n    c(lower, prob, upper)\n}\n\n\n\n#######################\n\n\n\n#barsData for survival curves plotting\n\nbarsDataSimpleSurv <- function(toPlot, target, risks, groups){\n    barsData <- expand.grid(risks, groups)\n    low <- numeric(nrow(barsData))\n    up <-  numeric(nrow(barsData))\n    prob <-  numeric(nrow(barsData))\n    for(i in 1:nrow(barsData)){\n        tmpBounds <- as.numeric(boundsSimpleSurv(barsData[i,1],barsData[i,2],target, toPlot))\n        low[i] <- tmpBounds[1]\n        prob[i] <- tmpBounds[2]\n        up[i] <- tmpBounds[3]\n    }\n\n    barsData <- cbind(barsData, low, prob, up)\n    colnames(barsData)[1:2] <- c(\"risk\", \"group\")\n    barsData\n}\n\n\n\n#######################\n\n#' @title Survival curves\n#' @name plotSurvival\n#' @description The function plots survival curves for each risk and group.\n#' @param fit a result of fitSurvival function.\n#' @param target point in time, in which the confidence bounds should be plotted.\n#' @param ggtheme ggtheme to be used (default: theme_minimal()).\n#' @param titleSurv a title of a plot (default: \"Survival Curves\").\n#' @param xtitle a title of x axis (default: \"Time\").\n#' @param ytitleSurv a title of y axis (default: \"Probability of survivng up to time t\")\n#' @param legendtitle a title of a legend (default: \"Group\").\n#' @return a ggplot containing n graphs, where n is number of risks. Each graph represents survival curves for given risk. One curve corresponds to one group.\n#' @export\n#' @examples fitS <- fitSurvival(time = \"time\", risk = \"event\", group = \"gender\", data = LUAD, cens = \"alive\", type = \"kaplan-meier\", conf.int = 0.95, conf.type = \"log\")\n#' plotSurvival(fit = fitS, target = 1200)\n#' @importFrom ggplot2 ggplot\n#' @importFrom dplyr filter\n#' @importFrom scales extended_breaks\n\nplotSurvival <- function(fit,\n                         target = NULL,\n                         ggtheme = theme_minimal(),\n                         titleSurv = \"Survival Curves\",\n                         xtitle = \"Time\",\n                         ytitleSurv = \"Probability of survivng up to time t\",\n                         legendtitle = \"Group\"\n\n                         ){\n\n    toPlot <- toPlotDf(fit)\n\n    timePoints <- extended_breaks()(toPlot$time)\n\n    #defining risks\n\n    risks <- unique(toPlot$risk)\n    risks <- levels(factor(risks))\n\n\n    #defining groups\n    groups <- unique(toPlot$group)\n    groups <- factor(groups)\n\n\n    if(!is.null(target) & is.numeric(target)){\n    barsData <- barsDataSimpleSurv(toPlot, target, risks, groups)}\n    pd <- position_dodge(0.9)\n\n    #making a plot\n\n    plot1 <- ggplot(data = toPlot, aes(time, prob, color = group)) +\n        geom_step(size=1) +\n        facet_grid(~risk)\n\n    if(!is.null(target) & is.numeric(target)){\n    plot1 <- plot1 +\n        geom_errorbar(data = barsData,\n                      mapping = aes(x = target, ymin = low, ymax = up),\n                      size = 1,\n                      alpha = 0.7,\n                      width = 0.7,\n                      position = pd)}\n\n    #theme\n    plot1 <- plot1 + ggtheme\n\n    #making it beauty\n    plot1 <- plot1 +\n        ggtitle(titleSurv) +\n        theme(plot.title = element_text(size=13, face=\"bold\", hjust = 0.5), legend.position = \"top\") +\n        scale_y_continuous(ytitleSurv, limits = c(0,1)) +\n        scale_x_continuous(xtitle, breaks = timePoints)+\n        theme(legend.title = element_text(size=10, face=\"bold\"))+\n        scale_color_discrete(name=legendtitle, labels = groups)\n\n    plot1\n\n}\n",
    "created" : 1499771370442.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "4225268051",
    "id" : "F6AD2780",
    "lastKnownWriteTime" : 1499776324,
    "last_content_update" : 1499776324323,
    "path" : "~/GitHub/cr17/package/R/plotSurvival.R",
    "project_path" : "R/plotSurvival.R",
    "properties" : {
        "tempName" : "Untitled1"
    },
    "relative_order" : 2,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}